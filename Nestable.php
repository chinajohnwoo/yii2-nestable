<?phpnamespace cszchen\nestable;use yii\web\Widget;use yii\helpers\ArrayHelper;use yii\helpers\Html;use cszchen\nestable\NestableAsset;class Nestable extends Widget{    public $items = [];        public $rootClass = 'dd';        public $listClass;        public $itemClass;        public $handleClass;        public $childAttribute = 'children';        public $pkAttribute = 'id';        public $defaultIconClass = 'fa fa-arrows';        public $actionButtons = [];        public $actionTemplate = "{create} {view} {update} {delete}";    	public $defaultButtonOptions = [	   'data-toggle' => 'tooltip',	];        /**     * What displayed in the item;     * It can be a property name or a callback function;     * If it is a property name, will display its value in the item,     * else it will display the return value;     * function ($item) {     *     $label = '?';     *     return $label;     * }     * @var unknown     */    public $display = 'label';        protected $controller;        public function init()    {        parent::init();        $this->controller = \Yii::$app->controller->id;        $this->initDefaultButtons();        $this->view->on(\yii\web\View::EVENT_END_BODY, function() {            NestableAsset::register($this->view);            $this->view->registerJs('$(".' . $this->rootClass . '").nestable()');        });        echo Html::tag('div', $this->renderItems($this->items), ['class'=>$this->rootClass]);    }        protected function renderItems($items)    {        if (!is_array($items)) {            return;        }        $html = '';        $html .= Html::beginTag('ol', ['class'=>'dd-list ' . $this->listClass]);        foreach ($items as $item) {            $options = [];            Html::addCssClass($options, 'dd-item dd2-item ' . $this->itemClass );                        $pk = $this->pkAttribute;            $options['data-'. $pk] = $item[$pk];            $html .= Html::beginTag('li', $options);            $html .= $this->renderItem($item);            if (isset($item[$this->childAttribute])) {                $html .= $this->renderItems($item[$this->childAttribute]);            }                        $html .= Html::endTag('li');        }        $html .= Html::endTag('ol');        return $html;    }        protected function renderItem($item)    {        $html = '';        $options = ArrayHelper::getValue($item, 'options', []);        Html::addCssClass($options, 'dd-handle dd2-handle ' . $this->handleClass);        //$options = ArrayHelper::merge($this->defaultItemOptions, $options);        $html .= Html::beginTag('div', $options);        if (isset($item['icon'])) {            $html .= Html::tag('i', '', ['class'=>$item['icon'] . ' normal-icon']);        } else {            $html .= Html::tag('i', '', ['class'=>$this->defaultIconClass . ' normal-icon']);        }        $html .= Html::tag('i', '', ['class'=>'drag-icon fa fa-arrows']);        $html .= Html::endTag('div');        $html .= Html::beginTag('div', ['class'=>'dd2-content']);        $html .= $this->getDisplay($item);        $html .= $this->renderActionButons($item);        $html .= Html::endTag('div');        return $html;    }        protected function getDisplay($item)    {        if (is_string($this->display)) {            return isset($item[$this->display]) ? $item[$this->display] : null;        } else if ($this->display instanceof \Closure) {            return call_user_func($this->display, $item);        }        return null;    }        protected function renderActionButons($item)    {        $buttons = preg_replace_callback('/\\{([\w\-\/]+)\\}/', function ($matches) use ($item) {        	$name = $matches[1];        	$pk = $this->pkAttribute;        	if (isset($this->actionButtons[$name])) {        		$button = $this->actionButtons[$name];        		if (!isset($button['url'])) {        		    $button['url'] = [$this->controller . '/' . $name];        		}        		is_array($button['url']) && $button['url'][$pk] = $item[$pk];        		$icon = isset($button['icon']) ? Html::tag('i', '', ['class'=>$button['icon']]) : '';        		$label = ArrayHelper::getValue($button, 'label', '');        		$options = ArrayHelper::merge($this->defaultButtonOptions, ArrayHelper::getValue($button, 'options', []));        		return Html::a($icon. $label, $button['url'], $options);        	} else {        		return '';        	}        }, $this->actionTemplate);        return Html::tag('div', $buttons, ['class'=>'pull-right action-buttons']);    }        protected function initDefaultButtons()    {        if (!isset($this->actionButtons['update'])) {        	$this->actionButtons['update'] = [	            'icon' => 'fa fa-pencil-square-o',	            'options' => ['title' => 'Update'],        	];        }        if (!isset($this->actionButtons['create'])) {        	$this->actionButtons['create'] = [            	'icon' => 'fa fa-plus-square-o',            	'options' => ['title' => 'Create'],        	];        }                if (!isset($this->actionButtons['delete'])) {            $this->actionButtons['delete'] = [                'icon' => 'fa fa-trash-o',                'options' => ['title' => 'Delete'],            ];        }        if (!isset($this->actionButtons['view'])) {            $this->actionButtons['view'] = [                'icon' => 'fa fa-eye',                'options' => ['title' => 'View'],            ];        }    }}